<!DOCTYPE html>
<html data-content_root="../../" lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="width=device-width,initial-scale=1" name="viewport"/>
  <meta content="ie=edge" http-equiv="x-ua-compatible"/>
  <meta content="Copy to clipboard" name="lang:clipboard.copy"/>
  <meta content="Copied to clipboard" name="lang:clipboard.copied"/>
  <meta content="en" name="lang:search.language"/>
  <meta content="True" name="lang:search.pipeline.stopwords"/>
  <meta content="True" name="lang:search.pipeline.trimmer"/>
  <meta content="No matching documents" name="lang:search.result.none"/>
  <meta content="1 matching document" name="lang:search.result.one"/>
  <meta content="# matching documents" name="lang:search.result.other"/>
  <meta content="[\s\-]+" name="lang:search.tokenizer"/>
  <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&amp;display=fallback" rel="stylesheet"/>
  <style>
   body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
  </style>
  <link href="../../_static/stylesheets/application.css" rel="stylesheet"/>
  <link href="../../_static/stylesheets/application-palette.css" rel="stylesheet"/>
  <link href="../../_static/stylesheets/application-fixes.css" rel="stylesheet"/>
  <link href="../../_static/fonts/material-icons.css" rel="stylesheet"/>
  <meta content="#4051b5" name="theme-color"/>
  <script src="../../_static/javascripts/modernizr.js">
  </script>
  <link href="../../_static/images/oras.png" rel="apple-touch-icon"/>
  <title>
   oras.provider — Oras Python
  </title>
  <link href="../../_static/pygments.css?v=83e35b93" rel="stylesheet" type="text/css"/>
  <link href="../../_static/material.css?v=79c92029" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css?v=76b2166b" rel="stylesheet" type="text/css"/>
  <link href="../../_static/css/rtd_sphinx_search.min.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/custom.css?v=d68d0989" rel="stylesheet" type="text/css"/>
  <script src="../../_static/documentation_options.js?v=0e525676">
  </script>
  <script src="../../_static/doctools.js?v=9a2dae69">
  </script>
  <script src="../../_static/sphinx_highlight.js?v=dc90522c">
  </script>
  <script src="../../_static/clipboard.min.js?v=a7894cd8">
  </script>
  <script src="../../_static/copybutton.js?v=f281be69">
  </script>
  <script src="../../_static/js/rtd_search_config.js">
  </script>
  <script src="../../_static/js/rtd_sphinx_search.min.js">
  </script>
  <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js">
  </script>
  <link href="../../_static/favicon.ico" rel="icon"/>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
  <!-- Social: Facebook / Open Graph -->
  <title>
   Oras Python
  </title>
  <link href="https://oras-project.github.io/oras-py/" rel="canonical"/>
  <meta content="website" property="og:type"/>
  <meta content="https://oras-project.github.io/oras-py/" property="og:url"/>
  <meta content="Oras Python" property="og:title"/>
  <meta content="https://raw.githubusercontent.com/oras-project/oras-py/main/docs/images/oras.png" property="og:image"/>
  <meta content="OCI Registry as Storage (ORAS) in Python" property="og:description"/>
  <meta content="Oras Python" property="og:site_name"/>
  <meta content="en_US" property="og:locale"/>
  <!-- Social: Twitter -->
  <meta content="summary" name="twitter:card"/>
  <meta content="@orasproject" name="twitter:site"/>
  <meta content="ORAS" name="twitter:title"/>
  <meta content="OCI Registry as Storage (ORAS) in Python" name="twitter:description"/>
  <meta content="https://raw.githubusercontent.com/oras-project/oras-py/main/docs/images/oras.png" name="twitter:image"/>
  <!-- Social: Google+ / Schema.org  -->
  <meta content="Oras Python" itemprop="name"/>
  <meta content="OCI Registry as Storage (ORAS) in Python" itemprop="description"/>
  <meta content="https://raw.githubusercontent.com/oras-project/oras-py/main/docs/images/oras.png" itemprop="image"/>
  <script type="application/ld+json">
   {"@type":"WebSite","headline":"Oras Python","url":"https://oras-project.github.io/oras-py","description":"OCI Registry as Storage (ORAS) Python","name":"Oras Python","@context":"https://schema.org"}
  </script>
  <link href="../../_static/images/oras.png" rel="apple-touch-icon"/>
 </head>
 <body data-md-color-accent="cyan" data-md-color-primary="indigo" dir="ltr">
  <svg class="md-svg">
   <defs data-children-count="0">
    <svg height="448" id="__github" viewbox="0 0 416 448" width="416" xmlns="http://www.w3.org/2000/svg">
     <path d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z" fill="currentColor">
     </path>
    </svg>
   </defs>
  </svg>
  <input class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
  <input class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
  <label class="md-overlay" data-md-component="overlay" for="__drawer">
  </label>
  <a class="md-skip" href="#_modules/oras/provider" tabindex="1">
   Skip to content
  </a>
  <header class="md-header" data-md-component="header">
   <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
     <div class="md-flex__cell md-flex__cell--shrink">
      <a class="md-header-nav__button md-logo" href="../../index.html" title="Oras Python">
       <i class="md-icon">
        
       </i>
      </a>
     </div>
     <div class="md-flex__cell md-flex__cell--shrink">
      <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer">
      </label>
     </div>
     <div class="md-flex__cell md-flex__cell--stretch">
      <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
       <span class="md-header-nav__topic">
        Oras Python
       </span>
       <span class="md-header-nav__topic">
        oras.provider
       </span>
      </div>
     </div>
     <div class="md-flex__cell md-flex__cell--shrink">
      <label class="md-icon md-icon--search md-header-nav__button" for="__search">
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
       <label class="md-search__overlay" for="__search">
       </label>
       <div class="md-search__inner" role="search">
        <form action="../../search.html" class="md-search__form" method="get" name="search">
         <input autocapitalize="off" autocomplete="off" class="md-search__input" data-md-component="query" data-md-state="active" name="q" placeholder="" search="" spellcheck="false" type="text"/>
         <label class="md-icon md-search__icon" for="__search">
         </label>
         <button class="md-icon md-search__icon" data-md-component="reset" tabindex="-1" type="reset">
          
         </button>
        </form>
        <div class="md-search__output">
         <div class="md-search__scrollwrap" data-md-scrollfix="">
          <div class="md-search-result" data-md-component="result">
           <div class="md-search-result__meta">
            Type to start searching
           </div>
           <ol class="md-search-result__list">
           </ol>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
     <div class="md-flex__cell md-flex__cell--shrink">
      <div class="md-header-nav__source">
       <a class="md-source" data-md-source="github" href="https://github.com/oras-project/oras-py/" title="Go to repository">
        <div class="md-source__icon">
         <!--<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>-->
         <!-- updated to match riverml.xml site-->
         <svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
          <path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z" fill="#ffffff">
          </path>
         </svg>
        </div>
        <div class="md-source__repository">
         Oras Python
        </div>
       </a>
      </div>
     </div>
    </div>
   </nav>
  </header>
  <div class="md-container">
   <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
     <ul class="md-tabs__list">
      <li class="md-tabs__item">
       <a class="md-tabs__link" href="https://oras.land">
        oras.land
       </a>
      </li>
      <li class="md-tabs__item">
       <a class="md-tabs__link" href="https://github.com/oras-project">
        Oras on GitHub
       </a>
      </li>
      <li class="md-tabs__item">
       <a class="md-tabs__link" href="https://github.com/oras-project/oras-py">
        Oras Python on GitHub
       </a>
      </li>
      <li class="md-tabs__item">
       <a class="md-tabs__link" href="../index.html">
        Module code
       </a>
      </li>
     </ul>
    </div>
   </nav>
   <main class="md-main">
    <div class="md-main__inner md-grid" data-md-component="container">
     <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
      <div class="md-sidebar__scrollwrap">
       <div class="md-sidebar__inner">
        <nav class="md-nav md-nav--primary" data-md-level="0">
         <label class="md-nav__title md-nav__title--site" for="__drawer">
          <a class="md-nav__button md-logo" href="../../index.html" title="Oras Python">
           <i class="md-icon">
            
           </i>
          </a>
          <a href="../../index.html" title="Oras Python">
           Oras Python
          </a>
         </label>
         <div class="md-nav__source">
          <a class="md-source" data-md-source="github" href="https://github.com/oras-project/oras-py/" title="Go to repository">
           <div class="md-source__icon">
            <!--<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>-->
            <!-- updated to match riverml.xml site-->
            <svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
             <path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z" fill="#ffffff">
             </path>
            </svg>
           </div>
           <div class="md-source__repository">
            Oras Python
           </div>
          </a>
         </div>
         <ul class="md-nav__list">
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../getting_started/index.html">
            Guides
           </a>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../contributing.html">
            Contributing
           </a>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../about/license.html">
            Apache License
           </a>
          </li>
          <li class="md-nav__item">
           <span class="md-nav__link caption">
            <span class="caption-text">
             API
            </span>
           </span>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../source/modules.html">
            oras
           </a>
          </li>
         </ul>
        </nav>
       </div>
      </div>
     </div>
     <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
      <div class="md-sidebar__scrollwrap">
       <div class="md-sidebar__inner">
        <nav class="md-nav md-nav--secondary">
         <ul class="md-nav__list" data-md-scrollfix="">
          <li class="md-nav__item" id="searchbox">
          </li>
         </ul>
        </nav>
       </div>
      </div>
     </div>
     <div class="md-content">
      <article class="md-content__inner md-typeset" role="main">
       <h1 id="modules-oras-provider--page-root">
        Source code for oras.provider
       </h1>
       <div class="highlight">
        <pre>
<span></span><span class="n">__author__</span> <span class="o">=</span> <span class="s2">"Vanessa Sochat"</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">"Copyright The ORAS Authors."</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">"Apache-2.0"</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span><span class="p">,</span> <span class="n">nullcontext</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">asdict</span>
<span class="kn">from</span> <span class="nn">http.cookiejar</span> <span class="kn">import</span> <span class="n">DefaultCookiePolicy</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryDirectory</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">jsonschema</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">import</span> <span class="nn">oras.auth</span>
<span class="kn">import</span> <span class="nn">oras.container</span>
<span class="kn">import</span> <span class="nn">oras.decorator</span> <span class="k">as</span> <span class="nn">decorator</span>
<span class="kn">import</span> <span class="nn">oras.defaults</span>
<span class="kn">import</span> <span class="nn">oras.main.login</span> <span class="k">as</span> <span class="nn">login</span>
<span class="kn">import</span> <span class="nn">oras.oci</span>
<span class="kn">import</span> <span class="nn">oras.schemas</span>
<span class="kn">import</span> <span class="nn">oras.utils</span>
<span class="kn">from</span> <span class="nn">oras.logger</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">oras.types</span> <span class="kn">import</span> <span class="n">container_type</span>
<span class="kn">from</span> <span class="nn">oras.utils.fileio</span> <span class="kn">import</span> <span class="n">PathAndOptionalContent</span>


<div class="viewcode-block" id="temporary_empty_config">
<a class="viewcode-back" href="../../source/oras.html#oras.provider.temporary_empty_config">[docs]</a>
<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">temporary_empty_config</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="k">with</span> <span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdir</span><span class="p">:</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_tmpfile</span><span class="p">(</span><span class="n">tmpdir</span><span class="o">=</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">".json"</span><span class="p">)</span>
        <span class="n">oras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">config_file</span></div>



<div class="viewcode-block" id="Registry">
<a class="viewcode-back" href="../../source/oras.html#oras.provider.Registry">[docs]</a>
<span class="k">class</span> <span class="nc">Registry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Direct interactions with an OCI registry.</span>

<span class="sd">    This could also be called a "provider" when we add in the "copy" logic</span>
<span class="sd">    and the registry isn't necessarily the "remote" endpoint.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">hostname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">insecure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">tls_verify</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">auth_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"token"</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Create an ORAS client.</span>

<span class="sd">        The hostname is the remote registry to ping.</span>

<span class="sd">        :param hostname: the hostname of the registry to ping</span>
<span class="sd">        :type hostname: str</span>
<span class="sd">        :param registry: if provided, use this custom provider instead of default</span>
<span class="sd">        :type registry: oras.provider.Registry or None</span>
<span class="sd">        :param insecure: use http instead of https</span>
<span class="sd">        :type insecure: bool</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">hostname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"http"</span> <span class="k">if</span> <span class="n">insecure</span> <span class="k">else</span> <span class="s2">"https"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tls_verify</span> <span class="o">=</span> <span class="n">tls_verify</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tls_verify</span><span class="p">:</span>
            <span class="n">requests</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">()</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># Ignore all cookies: some registries try to set one</span>
        <span class="c1"># and take it as a sign they are talking to a browser,</span>
        <span class="c1"># trying to set further CSRF cookies (Harbor is such a case)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">set_policy</span><span class="p">(</span><span class="n">DefaultCookiePolicy</span><span class="p">(</span><span class="n">allowed_domains</span><span class="o">=</span><span class="p">[]))</span>

        <span class="c1"># Get custom backend, pass on session to share</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">get_auth_backend</span><span class="p">(</span><span class="n">auth_backend</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">"[oras-client]"</span>

<div class="viewcode-block" id="Registry.version">
<a class="viewcode-back" href="../../source/oras.html#oras.provider.Registry.version">[docs]</a>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_items</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Get the version of the client.</span>

<span class="sd">        :param return_items : return the dict of version info instead of string</span>
<span class="sd">        :type return_items: bool</span>
<span class="sd">        """</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">__version__</span>

        <span class="n">python_version</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span><span class="p">,</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">minor</span><span class="p">,</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">micro</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"Version"</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span> <span class="s2">"Python version"</span><span class="p">:</span> <span class="n">python_version</span><span class="p">}</span>

        <span class="c1"># If the user wants the dictionary of items returned</span>
        <span class="k">if</span> <span class="n">return_items</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">versions</span>

        <span class="c1"># Otherwise return a string that can be printed</span>
        <span class="k">return</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">"</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">versions</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span></div>


<div class="viewcode-block" id="Registry.delete_tags">
<a class="viewcode-back" href="../../source/oras.html#oras.provider.Registry.delete_tags">[docs]</a>
    <span class="k">def</span> <span class="nf">delete_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Delete one or more tags for a unique resource identifier.</span>

<span class="sd">        Returns those successfully deleted.</span>

<span class="sd">        :param name: container URI to parse</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param tags: single or multiple tags name to delete</span>
<span class="sd">        :type N: string or list</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tags</span><span class="p">]</span>
        <span class="n">deleted</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_tag</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
                <span class="n">deleted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">deleted</span></div>


<div class="viewcode-block" id="Registry.logout">
<a class="viewcode-back" href="../../source/oras.html#oras.provider.Registry.logout">[docs]</a>
    <span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        If auths are loaded, remove a hostname.</span>

<span class="sd">        :param hostname: the registry hostname to remove</span>
<span class="sd">        :type hostname: str</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">logout</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span></div>


<div class="viewcode-block" id="Registry.login">
<a class="viewcode-back" href="../../source/oras.html#oras.provider.Registry.login">[docs]</a>
    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">password_stdin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">tls_verify</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">hostname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Login to a registry.</span>

<span class="sd">        :param username: the user account name</span>
<span class="sd">        :type username: str</span>
<span class="sd">        :param password: the user account password</span>
<span class="sd">        :type password: str</span>
<span class="sd">        :param password_stdin: get the password from standard input</span>
<span class="sd">        :type password_stdin: bool</span>
<span class="sd">        :param insecure: use http instead of https</span>
<span class="sd">        :type insecure: bool</span>
<span class="sd">        :param tls_verify: verify tls</span>
<span class="sd">        :type tls_verify: bool</span>
<span class="sd">        :param hostname: the hostname to login to</span>
<span class="sd">        :type hostname: str</span>
<span class="sd">        :param config_path: list of config paths to add</span>
<span class="sd">        :type config_path: list</span>
<span class="sd">        """</span>
        <span class="c1"># Read password from stdin</span>
        <span class="k">if</span> <span class="n">password_stdin</span><span class="p">:</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># No username, try to get from stdin</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">"Username: "</span><span class="p">)</span>

        <span class="c1"># No password provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">password</span><span class="p">:</span>
            <span class="n">password</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">"Password: "</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">password</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"password required"</span><span class="p">)</span>

        <span class="c1"># Cut out early if we didn't get what we need</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">password</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">"Login"</span><span class="p">:</span> <span class="s2">"Not successful"</span><span class="p">}</span>

        <span class="c1"># Set basic auth for the auth client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">set_basic_auth</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

        <span class="c1"># Login</span>
        <span class="c1"># https://docker-py.readthedocs.io/en/stable/client.html?highlight=login#docker.client.DockerClient.login</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_docker_client</span><span class="p">(</span><span class="n">tls_verify</span><span class="o">=</span><span class="n">tls_verify</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span>
                <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
                <span class="n">registry</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span>
                <span class="n">dockercfg_path</span><span class="o">=</span><span class="n">config_path</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Fallback to manual login</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">login</span><span class="o">.</span><span class="n">DockerClient</span><span class="p">()</span><span class="o">.</span><span class="n">login</span><span class="p">(</span>
                <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                <span class="n">registry</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                <span class="n">dockercfg_path</span><span class="o">=</span><span class="n">config_path</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Registry.set_header">
<a class="viewcode-back" href="../../source/oras.html#oras.provider.Registry.set_header">[docs]</a>
    <span class="k">def</span> <span class="nf">set_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Courtesy function to set a header</span>

<span class="sd">        :param name: header name to set</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param value: header value to set</span>
<span class="sd">        :type value: str</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span></div>


    <span class="k">def</span> <span class="nf">_validate_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Ensure a blob path is in the present working directory or below.</span>

<span class="sd">        :param path: the path to validate</span>
<span class="sd">        :type path: str</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_manifest_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Parse an optional manifest config.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &lt;path&gt;:&lt;content-type&gt;</span>
<span class="sd">        path/to/config:application/vnd.oci.image.config.v1+json</span>
<span class="sd">        /dev/null:application/vnd.oci.image.config.v1+json</span>

<span class="sd">        :param ref: the manifest reference to parse (examples above)</span>
<span class="sd">        :type ref: str</span>
<span class="sd">        :return - A Tuple of the path and the content-type, using the default unknown</span>
<span class="sd">                  config media type if none found in the reference</span>
<span class="sd">        """</span>
        <span class="n">path_content</span><span class="p">:</span> <span class="n">PathAndOptionalContent</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">split_path_and_content</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path_content</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
            <span class="n">path_content</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">unknown_config_media_type</span>
        <span class="k">return</span> <span class="n">path_content</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">path_content</span><span class="o">.</span><span class="n">content</span>

<div class="viewcode-block" id="Registry.upload_blob">
<a class="viewcode-back" href="../../source/oras.html#oras.provider.Registry.upload_blob">[docs]</a>
    <span class="k">def</span> <span class="nf">upload_blob</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">blob</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">container</span><span class="p">:</span> <span class="n">container_type</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">do_chunked</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">default_chunksize</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Prepare and upload a blob.</span>

<span class="sd">        Large artifacts can be uploaded via a chunked approach (post, patch+, put)</span>
<span class="sd">        to registries that support it. Larger chunks generally give better throughput.</span>
<span class="sd">        Set do_chunked=True for chunked upload.</span>

<span class="sd">        :param blob: path to blob to upload</span>
<span class="sd">        :type blob: str</span>
<span class="sd">        :param container:  parsed container URI</span>
<span class="sd">        :type container: oras.container.Container or str</span>
<span class="sd">        :param layer: dict from oras.oci.NewLayer</span>
<span class="sd">        :type layer: dict</span>
<span class="sd">        :param do_chunked: if true do chunked blob upload. This allows upload of larger oci artifacts.</span>
<span class="sd">        :type do_chunked: bool</span>
<span class="sd">        :param chunk_size: if true use chunked upload.</span>
<span class="sd">        :type chunk_size: int</span>
<span class="sd">        """</span>
        <span class="n">blob</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>
        <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_container</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>

        <span class="c1"># Chunked for large, otherwise POST and PUT</span>
        <span class="c1"># This is currently disabled unless the user asks for it, as</span>
        <span class="c1"># it doesn't seem to work for all registries</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">do_chunked</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_upload</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_upload</span><span class="p">(</span>
                <span class="n">blob</span><span class="p">,</span>
                <span class="n">container</span><span class="p">,</span>
                <span class="n">layer</span><span class="p">,</span>
                <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># If we have an empty layer digest and the registry didn't accept, just return dummy successful response</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">,</span> <span class="mi">202</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">layer</span><span class="p">[</span><span class="s2">"digest"</span><span class="p">]</span> <span class="o">==</span> <span class="n">oras</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">blank_hash</span>
        <span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">()</span>
            <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="k">return</span> <span class="n">response</span></div>


    <span class="nd">@decorator</span><span class="o">.</span><span class="n">ensure_container</span>
    <span class="k">def</span> <span class="nf">delete_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="n">container_type</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Delete a tag for a container.</span>

<span class="sd">        :param container:  parsed container URI</span>
<span class="sd">        :type container: oras.container.Container or str</span>
<span class="sd">        :param tag: name of tag to delete</span>
<span class="sd">        :type tag: str</span>
<span class="sd">        """</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Deleting tag </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">head_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">manifest_url</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># get digest of manifest to delete</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_request</span><span class="p">(</span>
            <span class="n">head_url</span><span class="p">,</span>
            <span class="s2">"HEAD"</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">"Accept"</span><span class="p">:</span> <span class="s2">"application/vnd.oci.image.manifest.v1+json"</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Cannot find tag </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">digest</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"Docker-Content-Digest"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">digest</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Expected to find Docker-Content-Digest header."</span><span class="p">)</span>

        <span class="n">delete_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">manifest_url</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>  <span class="c1"># type: ignore</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_request</span><span class="p">(</span><span class="n">delete_url</span><span class="p">,</span> <span class="s2">"DELETE"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">202</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Delete was not successful: {response.json()}"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@decorator</span><span class="o">.</span><span class="n">ensure_container</span>
    <span class="k">def</span> <span class="nf">get_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="n">container_type</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Retrieve tags for a package.</span>

<span class="sd">        :param container:  parsed container URI</span>
<span class="sd">        :type container: oras.container.Container or str</span>
<span class="sd">        :param N: limit number of tags, None for all (default)</span>
<span class="sd">        :type N: Optional[int]</span>
<span class="sd">        """</span>
        <span class="n">retrieve_all</span> <span class="o">=</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">tags_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">tags_url</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>  <span class="c1"># type: ignore</span>
        <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">extract_tags</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">):</span>
<span class="w">            </span><span class="sd">"""</span>
<span class="sd">            Determine if we should continue based on new tags and under limit.</span>
<span class="sd">            """</span>
            <span class="n">json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">new_tags</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"tags"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_tags</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_tags</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">retrieve_all</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_do_paginated_request</span><span class="p">(</span><span class="n">tags_url</span><span class="p">,</span> <span class="nb">callable</span><span class="o">=</span><span class="n">extract_tags</span><span class="p">)</span>

        <span class="c1"># If we got a longer set than was asked for</span>
        <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">N</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[:</span><span class="n">N</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tags</span>

    <span class="k">def</span> <span class="nf">_do_paginated_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">callable</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Paginate a request for a URL.</span>

<span class="sd">        We look for the "Link" header to get the next URL to ping. If</span>
<span class="sd">        the callable returns True, we continue to the next page, otherwise</span>
<span class="sd">        we stop.</span>
<span class="sd">        """</span>
        <span class="c1"># Save the base url to add parameters to, assuming only the params change</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">parts</span><span class="o">.</span><span class="n">scheme</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">parts</span><span class="o">.</span><span class="n">netloc</span><span class="si">}</span><span class="s2">"</span>

        <span class="c1"># get all results using the pagination</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">"GET"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>

            <span class="c1"># Check 200 response, show errors if any</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_200_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

            <span class="n">want_more</span> <span class="o">=</span> <span class="nb">callable</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">want_more</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">link</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"next"</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"url"</span><span class="p">)</span>

            <span class="c1"># Get the next link</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">link</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># use link + base url to continue with next page</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">base_url</span><span class="si">}{</span><span class="n">link</span><span class="si">}</span><span class="s2">"</span>

    <span class="nd">@decorator</span><span class="o">.</span><span class="n">ensure_container</span>
    <span class="k">def</span> <span class="nf">get_blob</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">container</span><span class="p">:</span> <span class="n">container_type</span><span class="p">,</span>
        <span class="n">digest</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">stream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">head</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Retrieve a blob for a package.</span>

<span class="sd">        :param container:  parsed container URI</span>
<span class="sd">        :type container: oras.container.Container or str</span>
<span class="sd">        :param digest: sha256 digest of the blob to retrieve</span>
<span class="sd">        :type digest: str</span>
<span class="sd">        :param stream: stream the response (or not)</span>
<span class="sd">        :type stream: bool</span>
<span class="sd">        :param head: use head to determine if blob exists</span>
<span class="sd">        :type head: bool</span>
<span class="sd">        """</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s2">"GET"</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">head</span> <span class="k">else</span> <span class="s2">"HEAD"</span>
        <span class="n">blob_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">get_blob_url</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_request</span><span class="p">(</span><span class="n">blob_url</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>

<div class="viewcode-block" id="Registry.get_container">
<a class="viewcode-back" href="../../source/oras.html#oras.provider.Registry.get_container">[docs]</a>
    <span class="k">def</span> <span class="nf">get_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">container_type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oras</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">Container</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Courtesy function to get a container from a URI.</span>

<span class="sd">        :param name: unique resource identifier to parse</span>
<span class="sd">        :type name: oras.container.Container or str</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">oras</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">Container</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">name</span>
        <span class="k">return</span> <span class="n">oras</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">Container</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">registry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span></div>


    <span class="c1"># Functions to be deprecated in favor of exposed ones</span>
    <span class="nd">@decorator</span><span class="o">.</span><span class="n">ensure_container</span>
    <span class="k">def</span> <span class="nf">_download_blob</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="n">container_type</span><span class="p">,</span> <span class="n">digest</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">"This function is deprecated in favor of download_blob and will be removed by 0.1.2"</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_blob</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">digest</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_put_upload</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">blob</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="n">oras</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">Container</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">"This function is deprecated in favor of put_upload and will be removed by 0.1.2"</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_upload</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_chunked_upload</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">blob</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="n">oras</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">Container</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">"This function is deprecated in favor of chunked_upload and will be removed by 0.1.2"</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_upload</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_upload_manifest</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">manifest</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="n">oras</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">Container</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">"This function is deprecated in favor of upload_manifest and will be removed by 0.1.2"</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_manifest</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">container</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_upload_blob</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">blob</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">container</span><span class="p">:</span> <span class="n">container_type</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">do_chunked</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">"This function is deprecated in favor of upload_blob and will be removed by 0.1.2"</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_blob</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">do_chunked</span><span class="p">)</span>

    <span class="nd">@decorator</span><span class="o">.</span><span class="n">ensure_container</span>
    <span class="k">def</span> <span class="nf">download_blob</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="n">container_type</span><span class="p">,</span> <span class="n">digest</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Stream download a blob into an output file.</span>

<span class="sd">        This function is a wrapper around get_blob.</span>

<span class="sd">        :param container:  parsed container URI</span>
<span class="sd">        :type container: oras.container.Container or str</span>
<span class="sd">        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Ensure output directory exists first</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">outdir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
                <span class="n">oras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_blob</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">digest</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

        <span class="c1"># Allow an empty layer to fail and return /dev/null</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">digest</span> <span class="o">==</span> <span class="n">oras</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">blank_hash</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">devnull</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">return</span> <span class="n">outfile</span>

<div class="viewcode-block" id="Registry.put_upload">
<a class="viewcode-back" href="../../source/oras.html#oras.provider.Registry.put_upload">[docs]</a>
    <span class="k">def</span> <span class="nf">put_upload</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">blob</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">container</span><span class="p">:</span> <span class="n">oras</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">Container</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Upload to a registry via put.</span>

<span class="sd">        :param blob: path to blob to upload</span>
<span class="sd">        :type blob: str</span>
<span class="sd">        :param container:  parsed container URI</span>
<span class="sd">        :type container: oras.container.Container or str</span>
<span class="sd">        :param layer: dict from oras.oci.NewLayer</span>
<span class="sd">        :type layer: dict</span>
<span class="sd">        """</span>
        <span class="c1"># Start an upload session</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"Content-Type"</span><span class="p">:</span> <span class="s2">"application/octet-stream"</span><span class="p">}</span>

        <span class="n">upload_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">upload_blob_url</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_request</span><span class="p">(</span><span class="n">upload_url</span><span class="p">,</span> <span class="s2">"POST"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

        <span class="c1"># Location should be in the header</span>
        <span class="n">session_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_location</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">container</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session_url</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Issue retrieving session url: </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># PUT to upload blob url</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"Content-Length"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s2">"size"</span><span class="p">]),</span>
            <span class="s2">"Content-Type"</span><span class="p">:</span> <span class="s2">"application/octet-stream"</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">blob_url</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">append_url_params</span><span class="p">(</span>
            <span class="n">session_url</span><span class="p">,</span> <span class="p">{</span><span class="s2">"digest"</span><span class="p">:</span> <span class="n">layer</span><span class="p">[</span><span class="s2">"digest"</span><span class="p">]}</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_request</span><span class="p">(</span>
                <span class="n">blob_url</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">"PUT"</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div>


    <span class="k">def</span> <span class="nf">_get_location</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="n">oras</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">Container</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Parse the location header and ensure it includes a hostname.</span>
<span class="sd">        This currently assumes if there isn't a hostname, we are pushing to</span>
<span class="sd">        the same registry hostname of the original request.</span>

<span class="sd">        :param r: requests response with headers</span>
<span class="sd">        :type r: requests.Response</span>
<span class="sd">        :param container:  parsed container URI</span>
<span class="sd">        :type container: oras.container.Container or str</span>
<span class="sd">        """</span>
        <span class="n">session_url</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"location"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session_url</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">session_url</span>

        <span class="c1"># Some registries do not return the full registry hostname.  Check that</span>
        <span class="c1"># the url starts with a protocol scheme, change tracked with:</span>
        <span class="c1"># https://github.com/oras-project/oras-py/issues/78</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">registry</span><span class="si">}</span><span class="s2">"</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">session_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"http"</span><span class="p">):</span>
            <span class="n">session_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">session_url</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">return</span> <span class="n">session_url</span>

<div class="viewcode-block" id="Registry.chunked_upload">
<a class="viewcode-back" href="../../source/oras.html#oras.provider.Registry.chunked_upload">[docs]</a>
    <span class="k">def</span> <span class="nf">chunked_upload</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">blob</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">container</span><span class="p">:</span> <span class="n">oras</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">Container</span><span class="p">,</span>
        <span class="n">layer</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">default_chunksize</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Upload via a chunked upload.</span>

<span class="sd">        :param blob: path to blob to upload</span>
<span class="sd">        :type blob: str</span>
<span class="sd">        :param container:  parsed container URI</span>
<span class="sd">        :type container: oras.container.Container or str</span>
<span class="sd">        :param layer: dict from oras.oci.NewLayer</span>
<span class="sd">        :type layer: dict</span>
<span class="sd">        :param chunk_size: chunk size in bytes</span>
<span class="sd">        :type chunk_size: int</span>
<span class="sd">        """</span>
        <span class="c1"># Start an upload session</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"Content-Type"</span><span class="p">:</span> <span class="s2">"application/octet-stream"</span><span class="p">,</span> <span class="s2">"Content-Length"</span><span class="p">:</span> <span class="s2">"0"</span><span class="p">}</span>
        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>

        <span class="n">upload_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">upload_blob_url</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_request</span><span class="p">(</span><span class="n">upload_url</span><span class="p">,</span> <span class="s2">"POST"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

        <span class="c1"># Location should be in the header</span>
        <span class="n">session_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_location</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">container</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session_url</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Issue retrieving session url: </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Read the blob in chunks, for each do a patch</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">oras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">read_in_chunks</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">):</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">content_range</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">"Content-Range"</span><span class="p">:</span> <span class="n">content_range</span><span class="p">,</span>
                    <span class="s2">"Content-Length"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)),</span>
                    <span class="s2">"Content-Type"</span><span class="p">:</span> <span class="s2">"application/octet-stream"</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>

                <span class="c1"># Important to update with auth token if acquired</span>
                <span class="c1"># TODO call to auth here</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_200_response</span><span class="p">(</span>
                    <span class="n">r</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_request</span><span class="p">(</span>
                        <span class="n">session_url</span><span class="p">,</span> <span class="s2">"PATCH"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">session_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_location</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">container</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">session_url</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Issue retrieving session url: </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Finally, issue a PUT request to close blob</span>
        <span class="n">session_url</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">append_url_params</span><span class="p">(</span>
            <span class="n">session_url</span><span class="p">,</span> <span class="p">{</span><span class="s2">"digest"</span><span class="p">:</span> <span class="n">layer</span><span class="p">[</span><span class="s2">"digest"</span><span class="p">]}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_request</span><span class="p">(</span><span class="n">session_url</span><span class="p">,</span> <span class="s2">"PUT"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_check_200_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Helper function to ensure some flavor of 200</span>

<span class="sd">        :param response: request response to inspect</span>
<span class="sd">        :type response: requests.Response</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">,</span> <span class="mi">202</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_response_errors</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Issue with </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_response_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Given a failed request, look for OCI formatted error messages.</span>

<span class="sd">        :param response: request response to inspect</span>
<span class="sd">        :type response: requests.Response</span>
<span class="sd">        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"errors"</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"message"</span> <span class="ow">in</span> <span class="n">error</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">[</span><span class="s2">"message"</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<div class="viewcode-block" id="Registry.upload_manifest">
<a class="viewcode-back" href="../../source/oras.html#oras.provider.Registry.upload_manifest">[docs]</a>
    <span class="k">def</span> <span class="nf">upload_manifest</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">manifest</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">container</span><span class="p">:</span> <span class="n">oras</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">Container</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Read a manifest file and upload it.</span>

<span class="sd">        :param manifest: manifest to upload</span>
<span class="sd">        :type manifest: dict</span>
<span class="sd">        :param container:  parsed container URI</span>
<span class="sd">        :type container: oras.container.Container or str</span>
<span class="sd">        """</span>
        <span class="n">jsonschema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">oras</span><span class="o">.</span><span class="n">schemas</span><span class="o">.</span><span class="n">manifest</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"Content-Type"</span><span class="p">:</span> <span class="n">oras</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">default_manifest_media_type</span><span class="p">,</span>
            <span class="s2">"Content-Length"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">manifest</span><span class="p">)),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_request</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">manifest_url</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>  <span class="c1"># noqa</span>
            <span class="s2">"PUT"</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="n">manifest</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Registry.push">
<a class="viewcode-back" href="../../source/oras.html#oras.provider.Registry.push">[docs]</a>
    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">config_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">disable_path_validation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">manifest_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">annotation_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">manifest_annotations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">subject</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">do_chunked</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">default_chunksize</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Push a set of files to a target</span>

<span class="sd">        :param config_path: path to a config file</span>
<span class="sd">        :type config_path: str</span>
<span class="sd">        :param disable_path_validation: ensure paths are relative to the running directory.</span>
<span class="sd">        :type disable_path_validation: bool</span>
<span class="sd">        :param files: list of files to push</span>
<span class="sd">        :type files: list</span>
<span class="sd">        :param insecure: allow registry to use http</span>
<span class="sd">        :type insecure: bool</span>
<span class="sd">        :param annotation_file: manifest annotations file</span>
<span class="sd">        :type annotation_file: str</span>
<span class="sd">        :param manifest_annotations: manifest annotations</span>
<span class="sd">        :type manifest_annotations: dict</span>
<span class="sd">        :param target: target location to push to</span>
<span class="sd">        :type target: str</span>
<span class="sd">        :param do_chunked: if true do chunked blob upload</span>
<span class="sd">        :type do_chunked: bool</span>
<span class="sd">        :param chunk_size: chunk size in bytes</span>
<span class="sd">        :type chunk_size: int</span>
<span class="sd">        :param subject: optional subject reference</span>
<span class="sd">        :type subject: oras.oci.Subject</span>
<span class="sd">        """</span>
        <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_container</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">files</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">load_configs</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">configs</span><span class="o">=</span><span class="n">config_path</span><span class="p">)</span>

        <span class="c1"># Prepare a new manifest</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">NewManifest</span><span class="p">()</span>

        <span class="c1"># A lookup of annotations we can add (to blobs or manifest)</span>
        <span class="n">annotset</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">Annotations</span><span class="p">(</span><span class="n">annotation_file</span><span class="p">)</span>
        <span class="n">media_type</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Upload files as blobs</span>
        <span class="k">for</span> <span class="n">blob</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="c1"># You can provide a blob + content type</span>
            <span class="n">path_content</span><span class="p">:</span> <span class="n">PathAndOptionalContent</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">split_path_and_content</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">blob</span> <span class="o">=</span> <span class="n">path_content</span><span class="o">.</span><span class="n">path</span>
            <span class="n">media_type</span> <span class="o">=</span> <span class="n">path_content</span><span class="o">.</span><span class="n">content</span>

            <span class="c1"># Must exist</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">blob</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">blob</span><span class="si">}</span><span class="s2"> does not exist."</span><span class="p">)</span>

            <span class="c1"># Path validation means blob must be relative to PWD.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">disable_path_validation</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_path</span><span class="p">(</span><span class="n">blob</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">"Blob </span><span class="si">{</span><span class="n">blob</span><span class="si">}</span><span class="s2"> is not in the present working directory context."</span>
                    <span class="p">)</span>

            <span class="c1"># Save directory or blob name before compressing</span>
            <span class="n">blob_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>

            <span class="c1"># If it's a directory, we need to compress</span>
            <span class="n">cleanup_blob</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">blob</span><span class="p">):</span>
                <span class="n">blob</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">make_targz</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>
                <span class="n">cleanup_blob</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Create a new layer from the blob</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">NewLayer</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="n">is_dir</span><span class="o">=</span><span class="n">cleanup_blob</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="n">media_type</span><span class="p">)</span>
            <span class="n">annotations</span> <span class="o">=</span> <span class="n">annotset</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>

            <span class="c1"># Always strip blob_name of path separator</span>
            <span class="n">layer</span><span class="p">[</span><span class="s2">"annotations"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">oras</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">annotation_title</span><span class="p">:</span> <span class="n">blob_name</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">annotations</span><span class="p">:</span>
                <span class="n">layer</span><span class="p">[</span><span class="s2">"annotations"</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>

            <span class="c1"># update the manifest with the new layer</span>
            <span class="n">manifest</span><span class="p">[</span><span class="s2">"layers"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Preparing layer </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="c1"># Upload the blob layer</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_blob</span><span class="p">(</span>
                <span class="n">blob</span><span class="p">,</span>
                <span class="n">container</span><span class="p">,</span>
                <span class="n">layer</span><span class="p">,</span>
                <span class="n">do_chunked</span><span class="o">=</span><span class="n">do_chunked</span><span class="p">,</span>
                <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_200_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

            <span class="c1"># Do we need to cleanup a temporary targz?</span>
            <span class="k">if</span> <span class="n">cleanup_blob</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">blob</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>

        <span class="c1"># Add annotations to the manifest, if provided</span>
        <span class="n">manifest_annots</span> <span class="o">=</span> <span class="n">annotset</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">(</span><span class="s2">"$manifest"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="c1"># Custom manifest annotations from client key=value pairs</span>
        <span class="c1"># These over-ride any potentially provided from file</span>
        <span class="n">custom_annots</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">manifest_annotations</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">custom_annots</span><span class="p">:</span>
            <span class="n">manifest_annots</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">custom_annots</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">manifest_annots</span><span class="p">:</span>
            <span class="n">manifest</span><span class="p">[</span><span class="s2">"annotations"</span><span class="p">]</span> <span class="o">=</span> <span class="n">manifest_annots</span>

        <span class="k">if</span> <span class="n">subject</span><span class="p">:</span>
            <span class="n">manifest</span><span class="p">[</span><span class="s2">"subject"</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>

        <span class="c1"># Prepare the manifest config (temporary or one provided)</span>
        <span class="n">config_annots</span> <span class="o">=</span> <span class="n">annotset</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">(</span><span class="s2">"$config"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">manifest_config</span><span class="p">:</span>
            <span class="n">ref</span><span class="p">,</span> <span class="n">media_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_manifest_ref</span><span class="p">(</span><span class="n">manifest_config</span><span class="p">)</span>
            <span class="n">conf</span><span class="p">,</span> <span class="n">config_file</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">ManifestConfig</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">media_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conf</span><span class="p">,</span> <span class="n">config_file</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">ManifestConfig</span><span class="p">()</span>

        <span class="c1"># Config annotations?</span>
        <span class="k">if</span> <span class="n">config_annots</span><span class="p">:</span>
            <span class="n">conf</span><span class="p">[</span><span class="s2">"annotations"</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_annots</span>

        <span class="c1"># Config is just another layer blob!</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Preparing config </span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">with</span> <span class="p">(</span>
            <span class="n">temporary_empty_config</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">config_file</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">nullcontext</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">config_file</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_blob</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_200_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="c1"># Final upload of the manifest</span>
        <span class="n">manifest</span><span class="p">[</span><span class="s2">"config"</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_manifest</span><span class="p">(</span>
            <span class="n">manifest</span><span class="p">,</span> <span class="n">container</span>
        <span class="p">)</span>  <span class="c1"># make the returned response from this method, the one pertaining to the uploaded Manifest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_200_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Successfully pushed </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="Registry.pull">
<a class="viewcode-back" href="../../source/oras.html#oras.provider.Registry.pull">[docs]</a>
    <span class="k">def</span> <span class="nf">pull</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">config_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">allowed_media_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">outdir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Pull an artifact from a target</span>

<span class="sd">        :param config_path: path to a config file</span>
<span class="sd">        :type config_path: str</span>
<span class="sd">        :param allowed_media_type: list of allowed media types</span>
<span class="sd">        :type allowed_media_type: list or None</span>
<span class="sd">        :param overwrite: if output file exists, overwrite</span>
<span class="sd">        :type overwrite: bool</span>
<span class="sd">        :param manifest_config_ref: save manifest config to this file</span>
<span class="sd">        :type manifest_config_ref: str</span>
<span class="sd">        :param outdir: output directory path</span>
<span class="sd">        :type outdir: str</span>
<span class="sd">        :param target: target location to pull from</span>
<span class="sd">        :type target: str</span>
<span class="sd">        """</span>
        <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_container</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">load_configs</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">configs</span><span class="o">=</span><span class="n">config_path</span><span class="p">)</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_manifest</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">allowed_media_type</span><span class="p">)</span>
        <span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span> <span class="ow">or</span> <span class="n">oras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_tmpdir</span><span class="p">()</span>
        <span class="n">overwrite</span> <span class="o">=</span> <span class="n">overwrite</span>

        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">manifest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"layers"</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"annotations"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">oras</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">annotation_title</span>
            <span class="p">)</span>

            <span class="c1"># If we don't have a filename, default to digest. Hopefully does not happen</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">layer</span><span class="p">[</span><span class="s2">"digest"</span><span class="p">]</span>

            <span class="c1"># This raises an error if there is a malicious path</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">sanitize_path</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfile</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s2"> already exists and --keep-old-files set, will not overwrite."</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># A directory will need to be uncompressed and moved</span>
            <span class="k">if</span> <span class="n">layer</span><span class="p">[</span><span class="s2">"mediaType"</span><span class="p">]</span> <span class="o">==</span> <span class="n">oras</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">default_blob_dir_media_type</span><span class="p">:</span>
                <span class="n">targz</span> <span class="o">=</span> <span class="n">oras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_tmpfile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">".tar.gz"</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download_blob</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">layer</span><span class="p">[</span><span class="s2">"digest"</span><span class="p">],</span> <span class="n">targz</span><span class="p">)</span>

                <span class="c1"># The artifact will be extracted to the correct name</span>
                <span class="n">oras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">extract_targz</span><span class="p">(</span><span class="n">targz</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">outfile</span><span class="p">))</span>

            <span class="c1"># Anything else just extracted directly</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download_blob</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">layer</span><span class="p">[</span><span class="s2">"digest"</span><span class="p">],</span> <span class="n">outfile</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Successfully pulled </span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">files</span></div>


    <span class="nd">@decorator</span><span class="o">.</span><span class="n">ensure_container</span>
    <span class="k">def</span> <span class="nf">get_manifest</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">container</span><span class="p">:</span> <span class="n">container_type</span><span class="p">,</span>
        <span class="n">allowed_media_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Retrieve a manifest for a package.</span>

<span class="sd">        :param container:  parsed container URI</span>
<span class="sd">        :type container: oras.container.Container or str</span>
<span class="sd">        :param allowed_media_type: one or more allowed media types</span>
<span class="sd">        :type allowed_media_type: str</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed_media_type</span><span class="p">:</span>
            <span class="n">allowed_media_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">oras</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">default_manifest_media_type</span><span class="p">]</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"Accept"</span><span class="p">:</span> <span class="s2">";"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allowed_media_type</span><span class="p">)}</span>

        <span class="n">get_manifest</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">manifest_url</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span>  <span class="c1"># type: ignore</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_request</span><span class="p">(</span><span class="n">get_manifest</span><span class="p">,</span> <span class="s2">"GET"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_200_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">jsonschema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">oras</span><span class="o">.</span><span class="n">schemas</span><span class="o">.</span><span class="n">manifest</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">manifest</span>

    <span class="nd">@decorator</span><span class="o">.</span><span class="n">classretry</span>
    <span class="k">def</span> <span class="nf">do_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"GET"</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">json</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Do a request. This is a wrapper around requests to handle retry auth.</span>

<span class="sd">        :param url: the URL to issue the request to</span>
<span class="sd">        :type url: str</span>
<span class="sd">        :param method: the method to use (GET, DELETE, POST, PUT, PATCH)</span>
<span class="sd">        :type method: str</span>
<span class="sd">        :param data: data for requests</span>
<span class="sd">        :type data: dict or bytes</span>
<span class="sd">        :param headers: headers for the request</span>
<span class="sd">        :type headers: dict</span>
<span class="sd">        :param json: json data for requests</span>
<span class="sd">        :type json: dict</span>
<span class="sd">        :param stream: stream the responses</span>
<span class="sd">        :type stream: bool</span>
<span class="sd">        """</span>
        <span class="c1"># Make the request and return to calling function, but attempt to use auth token if previously obtained</span>
        <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">,</span> <span class="n">oras</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">TokenAuth</span><span class="p">):</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">get_auth_header</span><span class="p">())</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
            <span class="n">method</span><span class="p">,</span>
            <span class="n">url</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="n">json</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span>
            <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tls_verify</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># A 401 response is a request for authentication, 404 is not found</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">401</span><span class="p">,</span> <span class="mi">403</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">response</span>

        <span class="c1"># Otherwise, authenticate the request and retry</span>
        <span class="n">headers</span><span class="p">,</span> <span class="n">changed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">authenticate_request</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">changed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Cannot respond to request for authentication."</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
            <span class="n">method</span><span class="p">,</span>
            <span class="n">url</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="n">json</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span>
            <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tls_verify</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># One retry if 403 denied (need new token?)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">,</span> <span class="n">changed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">authenticate_request</span><span class="p">(</span>
                <span class="n">response</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
                <span class="n">method</span><span class="p">,</span>
                <span class="n">url</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">json</span><span class="o">=</span><span class="n">json</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span>
                <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tls_verify</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span></div>

</pre>
       </div>
      </article>
     </div>
    </div>
   </main>
  </div>
  <footer class="md-footer">
   <div class="md-footer-nav">
    <nav class="md-footer-nav__inner md-grid">
    </nav>
   </div>
   <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
     <div class="md-footer-copyright">
      <div class="md-footer-copyright__highlight">
       © Copyright 2023, Oras Python Developers.
      </div>
      Last updated on
              Sep 24, 2024.
      <br/>
      Created using
      <a href="http://www.sphinx-doc.org/">
       Sphinx
      </a>
      8.0.2.
             and
      <a href="https://github.com/bashtage/sphinx-material/">
       Material for
              Sphinx
      </a>
     </div>
    </div>
   </div>
  </footer>
  <script src="../../_static/javascripts/application.js">
  </script>
  <script>
   app.initialize({version: "1.0.4", url: {base: ".."}})
  </script>
 </body>
</html>
